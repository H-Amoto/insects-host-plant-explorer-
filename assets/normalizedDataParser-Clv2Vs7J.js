const J=(s,a,r)=>{const t={moths:[],butterflies:[],beetles:[],leafbeetles:[]},l={};a.forEach(e=>{l[e.insect_id]||(l[e.insect_id]=[]);let o=e.plant_name;e.plant_family&&e.plant_family!=="以上バラ科"&&e.plant_family!=="以上ブナ科"&&(o+=`（${e.plant_family}）`),e.insect_id==="species-6115"&&console.log("DEBUG species-6115 hostplant data:",{plant_name:e.plant_name,observation_type:e.observation_type,plant_part:e.plant_part,life_stage:e.life_stage,reference:e.reference,notes:e.notes}),l[e.insect_id].push({name:e.plant_name,family:e.plant_family||"",displayName:o,observationType:e.observation_type||"野外（国内）",plantPart:e.plant_part||"葉",lifeStage:e.life_stage||"幼虫",reference:e.reference||"",notes:e.notes||"",isDetailed:!0})});const m={};return r.forEach(e=>{m[e.insect_id]||(m[e.insect_id]=[]),m[e.insect_id].push({type:e.note_type,content:e.content,reference:e.reference||"",page:e.page||"",year:e.year||""})}),s.forEach((e,o)=>{var u,y,b,d,p,_,h,g,P,N,D,v,E,$,j,w,I,B;try{const i=(u=e.insect_id)==null?void 0:u.trim();if(!i){console.warn(`正規化データ警告: 行${o+1}で昆虫IDが不明`);return}const f=l[i]||[],G=m[i]||[];i==="species-6115"&&(console.log("DEBUG species-6115 processing:",{insectId:i,hostPlants:f,hostPlantsCount:f.length}),f.forEach((n,S)=>{console.log(`DEBUG species-6115 hostPlant[${S}]:`,{name:n.name,observationType:n.observationType,plantPart:n.plantPart,lifeStage:n.lifeStage})}));const c={id:i,name:((y=e.japanese_name)==null?void 0:y.trim())||"不明",scientificName:((b=e.scientific_name)==null?void 0:b.trim())||"",family:((d=e.family_jp)==null?void 0:d.trim())||((p=e.family)==null?void 0:p.trim())||"",subfamily:((_=e.subfamily_jp)==null?void 0:_.trim())||((h=e.subfamily)==null?void 0:h.trim())||"",genus:((g=e.genus)==null?void 0:g.trim())||"",species:((P=e.species)==null?void 0:P.trim())||"",author:((N=e.author)==null?void 0:N.trim())||"",year:((D=e.year)==null?void 0:D.trim())||"",classification:{family:((v=e.family)==null?void 0:v.trim())||"",familyJapanese:((E=e.family_jp)==null?void 0:E.trim())||"",subfamily:(($=e.subfamily)==null?void 0:$.trim())||"",subfamilyJapanese:((j=e.subfamily_jp)==null?void 0:j.trim())||"",tribe:((w=e.tribe)==null?void 0:w.trim())||"",tribeJapanese:((I=e.tribe_jp)==null?void 0:I.trim())||""},hostPlants:f.map(n=>n.displayName),hostPlantsDetailed:f,generalNotes:G,dataSource:"normalized_csv",notes:((B=e.notes)==null?void 0:B.trim())||"",type:k(e.family_jp||e.family||"")};switch(T(e)){case"蛾類":t.moths.push(c);break;case"蝶類":t.butterflies.push(c);break;case"タマムシ類":t.beetles.push(c);break;case"ハムシ類":t.leafbeetles.push(c);break;default:t.moths.push(c)}}catch(i){console.error(`正規化データ処理エラー (行${o+1}):`,i,e)}}),console.log("正規化データ変換完了:",{moths:t.moths.length,butterflies:t.butterflies.length,beetles:t.beetles.length,leafbeetles:t.leafbeetles.length,total:t.moths.length+t.butterflies.length+t.beetles.length+t.leafbeetles.length}),t},T=s=>{var t,l;const a=((t=s.family_jp)==null?void 0:t.trim())||"",r=((l=s.family)==null?void 0:l.trim())||"";return a.includes("チョウ")||a.includes("シジミ")||a.includes("セセリ")?"蝶類":a.includes("タマムシ")?"タマムシ類":a.includes("ハムシ")||r==="Chrysomelidae"?"ハムシ類":r==="Buprestidae"?"タマムシ類":"蛾類"},k=s=>s.includes("チョウ")||s.includes("シジミ")||s.includes("セセリ")?"butterfly":s.includes("タマムシ")?"beetle":s.includes("ハムシ")?"leafbeetle":"moth",z=s=>{const a={totalRecords:0,withHostPlants:0,withDetailedHostPlants:0,withGeneralNotes:0,errors:[]};return["moths","butterflies","beetles","leafbeetles"].forEach(r=>{s[r]&&s[r].forEach((t,l)=>{a.totalRecords++,t.hostPlants&&t.hostPlants.length>0&&a.withHostPlants++,t.hostPlantsDetailed&&t.hostPlantsDetailed.length>0&&a.withDetailedHostPlants++,t.generalNotes&&t.generalNotes.length>0&&a.withGeneralNotes++,(!t.name||t.name==="不明")&&a.errors.push(`${r}[${l}]: 和名が不明`),t.scientificName||a.errors.push(`${r}[${l}]: 学名が未設定 (${t.name})`)})}),a};export{J as convertNormalizedDataToStandardFormat,z as validateNormalizedData};
